<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Dashboard Admin Database Reminder Kendaraan - Dishub</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- DataTables -->
  <link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css"/>
  <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.4.1/css/buttons.bootstrap5.min.css"/>

  <!-- Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">

  <!-- Common Styles -->
  <link rel="stylesheet" href="/static/common.css">

  <!-- SweetAlert2 -->
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* =========================
       THEME & LAYOUT VARIABLES
       ========================= */
    :root{
      --brand-blue-1: #0B41D4;
      --brand-blue-2: #00C6FF; /* cyan for gradient */
      --brand-green: #1DB954;
      --brand-red: #E74C3C;
      --brand-yellow: #F1C40F;
      --muted: #6C757D;
      --card-shadow: 0 12px 30px rgba(11,65,212,0.06);
      --glass: rgba(255,255,255,0.98);
      --btn-gradient: linear-gradient(135deg, var(--brand-blue-1) 0%, var(--brand-blue-2) 100%);
      --btn-height: 44px;
    }

    body {
      font-family: 'Inter', sans-serif;
      background-color: #f5f8fc;
      color: #1f2937;
      padding: 30px 18px;
    }

    /* ===== Header ===== */
    .header-title{
      font-weight:800;
      font-size:28px;
      color:#08203f;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .header-title i { color:var(--brand-blue-1); font-size:28px; }

    /* ===== Unified primary button style ===== */
    .btn-primary-custom {
      height: var(--btn-height);
      min-width:140px;
      padding:0 18px;
      border-radius:12px;
      border: none;
      display:inline-flex;
      align-items:center;
      gap:10px;
      justify-content:center;
      font-weight:700;
      color:#ffffff;
      background: var(--btn-gradient);
      box-shadow: 0 8px 24px rgba(11,65,212,0.10);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .btn-primary-custom:hover {
      transform: translateY(-2px);
      box-shadow: 0 14px 38px rgba(11,65,212,0.14);
      filter: brightness(0.98);
    }
    /* Icon sizing inside primary buttons */
    .btn-primary-custom .bi { font-size:18px; }

    /* Secondary / other action buttons */
    .btn-modern {
      height: var(--btn-height);
      padding:0 16px;
      border-radius:12px;
      display:inline-flex;
      align-items:center;
      gap:10px;
      font-weight:700;
      transition: transform .12s ease, box-shadow .12s ease;
    }
    .btn-add {
      background: linear-gradient(135deg,#5eead4,#60a5fa);
      border: none;
      color:#04243a;
    }
    .btn-add:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(94, 234, 212, 0.4);
    }
    .btn-refresh {
      background:#fff;
      border:1px solid #e6eef9;
      color:#1f2937;
    }
    .btn-refresh:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(108, 117, 125, 0.2);
    }
    .btn-logout {
      background: linear-gradient(135deg, #6ac030, #0bff03);
      border: none;
      color: #ffffff;
    }
    .btn-logout:hover {
      transform: scale(1.05);
      box-shadow: 0 8px 24px rgba(106, 192, 48, 0.4);
    }

    /* ===== Cards & form ===== */
    .card-surface {
      background:var(--glass);
      border-radius:14px;
      box-shadow:var(--card-shadow);
      padding:22px;
      margin-bottom:20px;
    }

    /* Stats cards */
    .stat-card{
      border-radius: 14px;
      padding: 18px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      min-height: 96px;
    }
    .stat-left{font-weight:700}
    .stat-sub{font-size:12px;color:var(--muted)}

    /* Table look */
    .table-card{
      border-radius:14px;
      overflow:hidden;
      background:#fff;
      box-shadow:var(--card-shadow);
      margin-bottom:14px;
    }
    .table thead th{
      background: linear-gradient(90deg,#b3c6ff,#81ecec);
      border-bottom:none;
      color:#04243a;
      font-weight:700;
    }
    .badge-status { font-weight:700; padding:6px 10px; border-radius:999px; font-size:.85rem; display:inline-block; }
    .badge-success { background:#e6f8ef; color:#0f9d58; }
    .badge-warning { background:#fff8e8; color:#a16207; }
    .badge-danger { background:#fff0f1; color:#be123c; }
    .badge-secondary { background:#f0f4f8; color:#475569; }

    /* small helpers */
    .controls { display:flex; gap:12px; align-items:center; }
    .search-input{ border-radius:12px; padding:10px 14px; border:1px solid #e6eef9; width:320px; }

    /* Status filter cards */
    .status-filter-card {
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-radius: 16px;
      background: #fff;
      box-shadow: 0 4px 14px rgba(0, 0, 0, 0.04);
      padding: 20px 24px;
      transition: all 0.2s ease;
      cursor: pointer;
    }
    .status-filter-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 18px rgba(0, 0, 0, 0.08);
    }
    .status-filter-card.active-card {
      background: var(--btn-gradient);
      color: white !important;
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 8px 24px rgba(11,65,212,0.4);
    }
    .status-filter-card.active-card h6,
    .status-filter-card.active-card h3,
    .status-filter-card.active-card i {
      color: white !important;
    }
    .status-filter-card[data-status="Semua Data"].active-card {
      background: linear-gradient(135deg, #0dcaf0, #0097b2);
    }

    /* Export button spin animation */
    @keyframes spin {
      from { transform: rotate(0deg); }
      to { transform: rotate(360deg); }
    }

    /* responsive */
    @media(max-width:900px){
      .controls { flex-direction:column; width:100%; }
      .search-input{ width:100%; }
    }

    @media(max-width:768px){
      .header-title { font-size:24px; }
      .controls { flex-direction:column; width:100%; }
      .search-input { width:100%; margin-bottom:10px; }
      #exportBtn { width:100%; }
    }

    @media(max-width:576px){
      .col-4.text-end { text-align:left !important; margin-top:15px; }
      .d-inline-block { display:flex !important; flex-direction:column; gap:8px; }
      .d-inline-block .btn { width:100%; margin-left:0 !important; margin-bottom:5px; }
      .header-title { font-size:22px; }
      .card-surface { padding:15px; }
      .table-responsive { margin:0 -15px; }
    }
  </style>
</head>
<body>
  <div class="container-fluid">
    <div class="row mb-4 align-items-center">
      <div class="col-auto">
        <div class="header-avatar position-relative">
          <img src="/static/uploads/avatar.png" id="headerAvatar" class="rounded-circle mb-0" 
               style="width:64px;height:64px;object-fit:cover;border:3px solid #fff;box-shadow:0 3px 10px rgba(0,0,0,0.1);"
               onerror="this.src='https://placehold.co/64x64/e6eef9/1f2937?text=Photo'">
          <button class="btn btn-sm btn-light position-absolute" style="bottom:-5px;right:-5px;border-radius:50%;width:24px;height:24px;padding:0;"
                  onclick="document.getElementById('headerAvatarInput').click()">
            <i class="bi bi-pencil-fill" style="font-size:12px"></i>
          </button>
          <input type="file" id="headerAvatarInput" accept="image/*" style="display:none">
        </div>
      </div>
      <div class="col">
        <div class="header-title gradient-text">Dashboard Database Reminder Kendaraan</div>
        <div class="text-muted" style="margin-top:6px">Database sistem manajemen pengingat uji kendaraan Dishub</div>
      </div>
      <div class="col-auto">
        <div class="d-flex gap-2">
          <button id="btnRefresh" class="btn btn-refresh btn-modern"><i class="bi bi-arrow-clockwise me-2"></i>Refresh</button>
          <button id="btnDashboard" class="btn btn-primary btn-modern" onclick="window.location.href='/dashboard'"><i class="bi bi-bar-chart me-2"></i>Monitoring</button>
          <button id="btnAdd" class="btn btn-add btn-modern"><i class="bi bi-plus-lg me-2"></i>Tambah Data</button>
          <button id="btnLogout" class="btn btn-logout btn-modern"><i class="bi bi-box-arrow-right me-2"></i>Logout</button>
        </div>
      </div>
    </div>


    <!-- top stats (diganti dengan status summary) -->
    <div class="row mb-4" id="statusSummary">
      <!-- Akan diisi via JS -->
    </div>

    <!-- table area -->
    <div class="row">
      <div class="col-12">
        <div class="table-card bg-white">
          <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <div>
              <h5 class="mb-0">Data Reminder</h5>
              <small class="text-muted">Data pengingat uji kendaraan</small>
            </div>

            <div class="controls">
              <input id="searchBox" class="search-input" placeholder="Cari nama, NIK, atau no kendaraan..." />
              <button id="exportBtn" class="btn btn-outline-secondary btn-modern"><i class="bi bi-download me-1"></i>Export</button>
            </div>
          </div>

          <div class="p-3">
            <div class="table-responsive">
              <div id="tableLoading" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Loading...</span>
                </div>
                <p class="mt-2 text-muted">Memuat data...</p>
              </div>
              <table id="reminderTable" class="table table-hover nowrap" style="width:100%">
                <thead>
                  <tr>
                    <th>ID</th>
                    <th>Nama</th>
                    <th>No Kendaraan</th>
                    <th>No Uji</th>
                    <th>Jenis Kendaraan</th>
                    <th>Tanggal Uji</th>
                    <th>Telepon</th>
                    <th>Status</th>
                    <th>Dibuat</th>
                    <th>Aksi</th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
            <div class="d-flex justify-content-between align-items-center mt-3">
              <div class="dataTables_info" id="reminderTable_info" role="status"></div>
              <div class="dataTables_paginate paging_simple_numbers" id="reminderTable_paginate"></div>
            </div>
          </div>

        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Modal -->
  <div class="modal fade" id="modalForm" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <form id="formReminder" class="modal-content" enctype="multipart/form-data">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Tambah Reminder</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="reminderId" />
          <div class="mb-3">
            <label class="form-label">Nama Pemilik <span class="text-muted" style="font-size:12px">(Sesuai STNK/KTP)</span></label>
            <input name="name" id="fName" class="form-control" required placeholder="Nama sesuai STNK/KTP" />
            <div class="invalid-feedback">Nama pemilik wajib diisi</div>
          </div>
          <div class="mb-3">
            <label class="form-label">No Kendaraan</label>
            <input name="vehicle_number" id="fVehicle" class="form-control" required placeholder="AB 1234 CD" />
            <div class="invalid-feedback">Nomor kendaraan wajib diisi</div>
          </div>
          <div class="mb-3">
            <label class="form-label">No Uji</label>
            <input name="no_uji" id="fNoUji" class="form-control" required placeholder="SLO 6798/BDG/6543/DPR 5890/JKT 3417" />
            <div class="invalid-feedback">Nomor uji wajib diisi</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Jenis Kendaraan</label>
            <select name="jenis_kendaraan" id="fJenisKendaraan" class="form-control" required>
              <option value="">Pilih Jenis Kendaraan</option>
              <option value="Truck">Truck</option>
              <option value="Pickup">Pickup</option>
              <option value="Mobil barang">Mobil barang</option>
              <option value="Tronton">Tronton</option>
            </select>
            <div class="invalid-feedback">Jenis kendaraan wajib dipilih</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Tanggal Uji</label>
            <input type="date" name="test_date" id="fDate" class="form-control" required />
            <div class="invalid-feedback">Tanggal uji wajib diisi</div>
          </div>
          <div class="mb-3">
            <label class="form-label">Telepon</label>
            <input name="phone" id="fPhone" class="form-control" placeholder="08xxxxxxxxxx" />
            <div class="form-text">Format: 08xxxxxxxxxx (opsional)</div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">Batal</button>
          <button type="submit" id="btnSave" class="btn btn-primary btn-modern">
            <span class="spinner-border spinner-border-sm d-none" id="saveSpinner" role="status" aria-hidden="true"></span>
            <span id="saveText">Simpan</span>
          </button>
        </div>
      </form>
    </div>
  </div>

  <script>
async function loadSummary() {
  const res = await fetch("/list?format=json");
  const data = await res.json();

  const counts = { expired: 0, today: 0, h1: 0, h2: 0, h3: 0 };

  data.forEach(r => {
    switch(r.status) {
      case "Expired": counts.expired++; break;
      case "H (today)": counts.today++; break;
      case "H-1": counts.h1++; break;
      case "H-2": counts.h2++; break;
      case "H-3 or more": counts.h3++; break;
    }
  });

  const mapping = [
    {label: "Semua Data", count: data.length, color: "info", icon: "bi-database-fill"},
    {label: "Expired", count: counts.expired, color: "secondary", icon: "bi-x-circle-fill"},
    {label: "H (today)", count: counts.today, color: "danger", icon: "bi-calendar-day"},
    {label: "H-1", count: counts.h1, color: "warning", icon: "bi-calendar-minus"},
    {label: "H-2", count: counts.h2, color: "primary", icon: "bi-calendar-event"},
    {label: "H-3+", count: counts.h3, color: "success", icon: "bi-calendar-check"}
  ];

  const container = document.getElementById("statusSummary");
  container.innerHTML = mapping.map(m => `
    <div class="col-md-2">
      <div class="card text-center border-${m.color} shadow-sm status-filter-card" data-status="${m.label}">
        <div class="card-body">
          <div class="mb-2"><i class="bi ${m.icon} text-${m.color}" style="font-size:26px"></i></div>
          <h6 class="card-title text-${m.color}">${m.label}</h6>
          <h3>${m.count}</h3>
        </div>
      </div>
    </div>
  `).join("");
}

// panggil saat load halaman
loadSummary();
</script>


  <!-- Dependencies -->
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

  <!-- DataTables -->
  <script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
  <script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/dataTables.buttons.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.bootstrap5.min.js"></script>
  <script src="https://cdn.datatables.net/buttons/2.4.1/js/buttons.html5.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
  <script>
    // === Logout ===
    document.addEventListener("DOMContentLoaded", () => {
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          Swal.fire({
            title: 'Logout?',
            text: 'Anda akan keluar dari Dashboard',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Logout',
            cancelButtonText: 'Batal'
          }).then(result => {
            if (result.isConfirmed) {
              Swal.fire({
                icon: 'success',
                title: 'Berhasil Logout',
                showConfirmButton: false,
                timer: 1200
              });
              setTimeout(() => {
                window.location.href = "http://127.0.0.1:5000/"; // redirect ke home
              }, 1300);
            }
          });
        });
      }
    });
  </script>

  <script>
    // Disable default DataTables alert and handle ajax errors gracefully
    $.fn.dataTable.ext.errMode = 'none';

    const apiList = '/list?format=json';
    const apiAdd = '/add';
    const apiEdit = (id) => `/edit/${id}`;
    const apiDelete = (id) => `/delete/${id}`;

    // normalize phone like backend expects (62...)
    function normalizePhone(phone) {
      if (!phone) return "";
      phone = phone.trim().replace(/\s+/g,'').replace(/-/g,'');
      if (phone.startsWith('+')) phone = phone.slice(1);
      if (phone.startsWith('0')) phone = '62' + phone.slice(1);
      if (!phone.startsWith('62')) phone = '62' + phone;
      return phone;
    }

    let table;
    $(document).ready(function(){
      // Show loading indicator
      $('#tableLoading').removeClass('d-none');
      
      // Initialize DataTable
      table = $('#reminderTable').DataTable({
        ajax: {
          url: apiList,
          dataSrc: '',
          beforeSend: function() {
            $('#tableLoading').removeClass('d-none');
            $('#reminderTable').addClass('d-none');
          },
          complete: function() {
            $('#tableLoading').addClass('d-none');
            $('#reminderTable').removeClass('d-none');
          },
          error: function(xhr, status, error){
            console.error('DataTables Ajax error', status, error, xhr);
            $('#tableLoading').addClass('d-none');
            Swal.fire({
              icon: 'error',
              title: 'Gagal memuat data',
              text: 'Tidak dapat memuat data dari server. Cek server backend atau konsol browser.'
            });
          }
        },
        buttons: [{
          extend: 'excelHtml5',
          text: '<i class="bi bi-file-earmark-spreadsheet-fill"></i> Excel',
          className: 'btn btn-sm btn-success d-none', // Hide default button
          filename: function() {
            let activeStatus = window.activeStatusFilter || "Semua Data";
            let dateStr = new Date().toISOString().split('T')[0];
            return activeStatus === "Semua Data" ? 
              `Reminder_Data_Semua_${dateStr}` : 
              `Reminder_Data_${activeStatus.replace(/[()]/g, '').replace(/\s+/g, '_')}_${dateStr}`;
          },
          exportOptions: {
            columns: [1, 2, 3, 4, 5, 6, 7],
            modifier: {
              search: 'applied',
              order: 'applied'
            }
          },
          customize: function(xlsx) {
            let sheet = xlsx.xl.worksheets['sheet1.xml'];
            $('row:first c', sheet).attr('s', '2');
            $('row c[r^="F"]', sheet).each(function() {
              if ($(this).text()) {
                $(this).attr('s', '1');
              }
            });
          }
        }],
        columns: [
          { data: null, width: '4%', render: function(data, type, row, meta) { return meta.row + 1; } },
          { data: 'name' },
          { data: 'vehicle_number' },
          { data: 'no_uji', defaultContent: '-' },
          { data: 'jenis_kendaraan', defaultContent: '-' },
          { data: 'test_date' },
          { data: 'phone', defaultContent: '-' },
          {
            data: null,
            render: function(d){
              const s = (d && d.status) ? d.status : 'Unknown';
              let cls = 'badge-secondary';
              switch (s) {
                case 'Expired': cls = 'badge-secondary'; break;
                case 'H (today)': cls = 'badge-danger'; break;
                case 'H-1': cls = 'badge-warning'; break;
                case 'H-3 or more': cls = 'badge-success'; break;
                default: cls = 'badge-secondary';
              }
              return `<span class="badge-status ${cls}">${s}</span>`;
            },
            orderable: false,
            width: '12%'
          },
          { data: 'created_at', width: '10%' },
          {
            data: null,
            render: function(d){
              return `
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-light btn-edit" data-id="${d.id}" title="Edit"><i class="bi bi-pencil"></i></button>
                  <button class="btn btn-sm btn-outline-danger btn-delete" data-id="${d.id}" title="Hapus"><i class="bi bi-trash"></i></button>
                </div>`;
            },
            orderable: false,
            width: '9%'
          }
        ],
        order: [[6, 'asc']],
        pageLength: 10,
        lengthChange: false,
        responsive: true,
        dom: 'Bfrtip',
        initComplete: function(){
          // hide default buttons, we'll use our own export button
          $('.dt-button').addClass('d-none');
          loadSummary(); // âœ… render summary + filter
        }
      });
      window.table = table; // pastikan global

      // Nomor urut dinamis (selalu urut 1,2,3... setelah filter/sort/page)
      table.on('order.dt search.dt draw.dt', function() {
        table.column(0, {search:'applied', order:'applied', page:'applied'}).nodes().each(function(cell, i) {
          cell.innerHTML = i + 1;
        });
      });

      // Status filter event (hanya pakai custom filter DataTables)
      let lastStatus = null;
      $(document).on('click', '.status-filter-card', function() {
        let status = $(this).data('status');
        
        // Reset all cards first
        document.querySelectorAll('.status-filter-card').forEach(c => c.classList.remove('active-card'));
        
        if (status === "Semua Data") {
          // Show all data
          window.activeStatusFilter = "Semua Data";
          table.draw();
          lastStatus = "Semua Data";
          this.classList.add('active-card');
        } else {
          // Handle other status filters
          if (status === 'H-3+') status = 'H-3 or more';
          if (lastStatus === status) {
            window.activeStatusFilter = null;
            table.draw();
            lastStatus = null;
          } else {
            window.activeStatusFilter = status;
            table.draw();
            lastStatus = status;
            this.classList.add('active-card');
          }
        }
      });

      // Tambahkan custom filter DataTables untuk status
      // Model: custom filter ini memfilter baris berdasarkan nilai status yang
      // dirender di kolom status (biasanya berwujud badge HTML). Fitur:
      // - Gunakan `window.activeStatusFilter` yang diset saat user klik status card
      // - Dukung `Semua Data` untuk menampilkan semua baris
      // - Mapping singkat: 'H-3+' -> 'H-3 or more'
      // - Hapus tag HTML sebelum perbandingan (karena status di-render sebagai badge)
      // - Perbandingan case-insensitive
      $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        // Jika Anda mengubah urutan kolom di thead, sesuaikan index ini (0-based)
        const statusColumnIndex = 7; // kolom ke-8 pada tabel

        const activeFilter = window.activeStatusFilter || null;
        // Jika tidak ada filter aktif atau filter 'Semua Data', biarkan semua baris
        if (!activeFilter || activeFilter === "Semua Data") return true;

        // Ambil nilai dari kolom status, hapus tag HTML (badge) dan trim
        const raw = data[statusColumnIndex] || '';
        const statusText = String(raw).replace(/<[^>]+>/g, '').trim();

        // Normalisasi beberapa kasus singkat (opsional)
        let compareFilter = activeFilter;
        if (compareFilter === 'H-3+') compareFilter = 'H-3 or more';

        // Bandingkan case-insensitive
        return statusText.toLowerCase() === String(compareFilter).toLowerCase();
      });

      // wire custom search box to datatable
      $('#searchBox').on('input', function(){
        table.search(this.value).draw();
      });

      // custom Export button triggers datatable export
      $('#exportBtn').on('click', async function(){
        const btn = $(this);
        const originalHtml = btn.html();
        
        // Get current active status
        let activeStatus = window.activeStatusFilter || "Semua Data";
        let filename = activeStatus === "Semua Data" ? 
          "Reminder_Data_Semua" : 
          `Reminder_Data_${activeStatus.replace(/[()]/g, '').replace(/\s+/g, '_')}`;
        
        // Get the current date for the filename
        let today = new Date();
        let dateStr = today.toISOString().split('T')[0];
        
        try {
          // Show loading state
          btn.html('<i class="bi bi-arrow-repeat spin me-1"></i> Exporting...').prop('disabled', true);
          
          // Get DataTables buttons API
          let excelButton = table.buttons('.buttons-excel').nodes()[0];
          
          // Set filename for export
          table.button('.buttons-excel').filename = `${filename}_${dateStr}`;
          
          // Trigger click on actual Excel button
          $(excelButton).trigger('click');
          
          // Show success message
          Swal.fire({
            icon: 'success',
            title: 'Export Berhasil',
            text: `Data ${activeStatus} berhasil di-export ke Excel`,
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
          });
        } catch (error) {
          console.error('Export error:', error);
          Swal.fire({
            icon: 'error',
            title: 'Export Gagal',
            text: 'Terjadi kesalahan saat mengexport data',
            toast: true,
            position: 'top-end',
            showConfirmButton: false,
            timer: 3000
          });
        } finally {
          // Reset button state
          btn.html(originalHtml).prop('disabled', false);
        }
      });

      // Refresh
      $('#btnRefresh').on('click', function(){
        table.ajax.reload(null, false);
        window.activeStatusFilter = "Semua Data";
        table.draw();
        // Activate Semua Data tab
        document.querySelectorAll('.status-filter-card').forEach(c => {
          if (c.getAttribute('data-status') === 'Semua Data') {
            c.classList.add('active-card');
          } else {
            c.classList.remove('active-card');
          }
        });
        Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Data sudah di-refresh', showConfirmButton:false, timer:1600 });
        loadSummary();
      });

      // Add button opens modal
      const modal = new bootstrap.Modal(document.getElementById('modalForm'));
      $('#btnAdd').on('click', function(){
        $('#modalTitle').text('Tambah Reminder Baru');
        $('#reminderId').val('');
        $('#formReminder')[0].reset();
        modal.show();
      });

      // Edit button (delegated)
      $('#reminderTable tbody').on('click', '.btn-edit', function(){
        const id = $(this).data('id');
        fetch(apiList).then(r=>r.json()).then(data=>{
          const row = data.find(x=>x.id == id);
          if (!row) { Swal.fire('Data tidak ditemukan'); return; }
          $('#modalTitle').text('Edit Reminder');
          $('#reminderId').val(row.id);
          $('#fName').val(row.name);
          $('#fVehicle').val(row.vehicle_number);
          $('#fNoUji').val(row.no_uji || '');
          $('#fJenisKendaraan').val(row.jenis_kendaraan || '');
          $('#fDate').val(row.test_date);
          $('#fPhone').val(row.phone || '');
          modal.show();
        }).catch(err=>{
          console.error(err);
          Swal.fire('Error', 'Gagal mengambil data untuk edit', 'error');
        });
      });

      // Delete button (delegated)
      $('#reminderTable tbody').on('click', '.btn-delete', function(){
        const id = $(this).data('id');
        Swal.fire({
          title: 'Yakin hapus?',
          text: `Hapus data ID ${id}?`,
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Ya, hapus',
        }).then(result=>{
          if (!result.isConfirmed) return;
          fetch(apiDelete(id), { method: 'DELETE' })
            .then(r=>{
              if (!r.ok) throw new Error('delete failed');
              return r.json();
            })
            .then(()=> {
              table.ajax.reload(null,false);
              loadSummary();
              Swal.fire({ icon:'success', title:'Terhapus', text:'Data berhasil dihapus', timer:1400, showConfirmButton:false });
            })
            .catch(err=>{
              console.error(err);
              Swal.fire('Gagal', 'Gagal menghapus data', 'error');
            });
        });
      });

      // Form validation
      function validateForm() {
        let isValid = true;
        const form = document.getElementById('formReminder');
        
        // Reset validation state
        form.querySelectorAll('.form-control').forEach(input => {
          input.classList.remove('is-invalid');
        });
        
        // Validate required fields
        form.querySelectorAll('.form-control[required]').forEach(input => {
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            isValid = false;
          }
        });
        
        return isValid;
      }
      
      // Submit add/edit form
      $('#formReminder').on('submit', function(e){
        e.preventDefault();
        
        // Validate form
        if (!validateForm()) {
          return;
        }
        
        // Show loading state
        $('#saveSpinner').removeClass('d-none');
        $('#saveText').text('Menyimpan...');
        $('#btnSave').attr('disabled', true);
        
        const id = $('#reminderId').val();
        const payload = {
          name: $('#fName').val().trim(),
          vehicle_number: $('#fVehicle').val().trim(),
          no_uji: $('#fNoUji').val().trim(),
          jenis_kendaraan: $('#fJenisKendaraan').val(),
          test_date: $('#fDate').val(),
          phone: normalizePhone($('#fPhone').val().trim())
        };

        if (id) {
          // edit
          fetch(apiEdit(id), {
            method: 'PUT',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          })
          .then(r=>{
            if (!r.ok) throw new Error('update failed');
            return r.json();
          })
          .then(()=> {
            // Reset loading state
            $('#saveSpinner').addClass('d-none');
            $('#saveText').text('Simpan');
            $('#btnSave').attr('disabled', false);
            
            modal.hide();
            table.ajax.reload(null,false);
            refreshStats();
            Swal.fire({ icon:'success', title:'Berhasil', text:'Data berhasil diupdate', timer:1400, showConfirmButton:false });
          })
          .catch(err=>{
            // Reset loading state
            $('#saveSpinner').addClass('d-none');
            $('#saveText').text('Simpan');
            $('#btnSave').attr('disabled', false);
            
            console.error(err);
            Swal.fire('Gagal', 'Gagal mengupdate data', 'error');
          });
        } else {
          // add
          fetch(apiAdd, {
            method: 'POST',
            headers: {'Content-Type':'application/json'},
            body: JSON.stringify(payload)
          })
          .then(r=>{
            if (!r.ok) throw new Error('add failed');
            return r.json();
          })
          .then(()=> {
            // Reset loading state
            $('#saveSpinner').addClass('d-none');
            $('#saveText').text('Simpan');
            $('#btnSave').attr('disabled', false);
            
            modal.hide();
            $('#formReminder')[0].reset();
            table.ajax.reload(null,false);
            refreshStats();
            Swal.fire({ icon:'success', title:'Berhasil', text:'Data berhasil ditambahkan', timer:1400, showConfirmButton:false });
          })
          .catch(err=>{
            // Reset loading state
            $('#saveSpinner').addClass('d-none');
            $('#saveText').text('Simpan');
            $('#btnSave').attr('disabled', false);
            
            console.error(err);
            Swal.fire('Gagal', 'Gagal menambah data', 'error');
          });
        }
      });

      // On table load, update stats
      table.on('xhr', function(){
        refreshStats();
      });

      // Header Avatar upload handling
      const headerAvatarInput = document.getElementById('headerAvatarInput');
      const headerAvatar = document.getElementById('headerAvatar');
      
      headerAvatarInput.addEventListener('change', function(e) {
        if (this.files && this.files[0]) {
          // Preview the selected image
          const reader = new FileReader();
          reader.onload = function(e) {
            headerAvatar.src = e.target.result;
          }
          reader.readAsDataURL(this.files[0]);
          
          // Upload the file
          const formData = new FormData();
          formData.append('avatar', this.files[0]);
          
          fetch('/upload-avatar', {
            method: 'POST',
            body: formData
          })
          .then(response => response.json())
          .then(data => {
            if (data.status === 'ok') {
              Swal.fire({
                icon: 'success',
                title: 'Foto berhasil diupload',
                toast: true,
                position: 'top-end',
                showConfirmButton: false,
                timer: 3000
              });
            } else {
              throw new Error(data.error || 'Upload failed');
            }
          })
          .catch(error => {
            console.error('Error:', error);
            Swal.fire({
              icon: 'error',
              title: 'Gagal upload foto',
              text: error.message,
              toast: true,
              position: 'top-end',
              showConfirmButton: false,
              timer: 3000
            });
          });
        }
      });


      
    }); // ready

    // compute and display stats from latest data
    function refreshStats(){
      fetch(apiList)
        .then(r=>r.json())
        .then(data=>{
          const total = data.length || 0;
          const active = data.filter(d=>d.color === 'success').length;
          const soon = data.filter(d=>d.color === 'warning').length;
          const expired = data.filter(d=>d.color === 'danger').length;
          $('#statTotal').text(total);
          $('#statActive').text(active);
          $('#statSoon').text(soon);
          $('#statExpired').text(expired);
        })
        .catch(err=>{
          console.warn('refreshStats error', err);
          // don't block UI if stats can't be loaded
        });
    }
  </script>
</body>
</html>
