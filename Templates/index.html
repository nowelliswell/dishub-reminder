<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>WhatsApp Reminder - Dishub</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .btn-refresh {
      background: linear-gradient(135deg,#5eead4,#60a5fa);
      border: none;
      color: #04243a;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(59,130,246,0.10);
      padding: 10px 16px;
      transition: box-shadow 0.18s, background 0.18s, color 0.18s;
    }
    .btn-refresh:hover, .btn-refresh:focus {
      background: linear-gradient(135deg,#60a5fa,#5eead4);
      color: #02111b;
      box-shadow: 0 6px 18px rgba(59,130,246,0.18);
    }
    :root{
      --bg1: #f6fbff;
      --accent1: #81d4fa;
      --accent2: #7ef6d7;
      --muted: #6b7280;
      --card-shadow: 0 10px 30px rgba(38,50,56,0.06);
    }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(120deg, #f8fafc 0%, #e9f4ff 60%, #f1f6f9 100%);
      color: #1f2937;
      padding: 30px 18px;
    }
    .header-title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 20px;
    }
    .header-title.gradient-text {
      /* Gradient text */
      background: linear-gradient(90deg, #00e676, #00bcd4, #448aff);
      background-clip: text;
      -webkit-background-clip: text; /* Safari/Chrome */
      color: transparent;
      -webkit-text-fill-color: transparent; /* Safari/Chrome */
    }
    
    /* Form validation styles */
    .form-control.is-invalid {
      border-color: #dc3545;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 12 12' width='12' height='12' fill='none' stroke='%23dc3545'%3e%3ccircle cx='6' cy='6' r='4.5'/%3e%3cpath stroke-linejoin='round' d='M5.8 3.6h.4L6 6.5z'/%3e%3ccircle cx='6' cy='8.2' r='.6' fill='%23dc3545' stroke='none'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .form-control.is-valid {
      border-color: #198754;
      background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 8 8'%3e%3cpath fill='%23198754' d='M2.3 6.73L.6 4.53c-.4-1.04.46-1.4 1.1-.8l1.1 1.4 3.4-3.8c.6-.63 1.6-.27 1.2.7l-4 4.6c-.43.5-.8.4-1.1.1z'/%3e%3c/svg%3e");
      background-repeat: no-repeat;
      background-position: right calc(0.375em + 0.1875rem) center;
      background-size: calc(0.75em + 0.375rem) calc(0.75em + 0.375rem);
    }
    
    .invalid-feedback {
      display: none;
      width: 100%;
      margin-top: 0.25rem;
      font-size: 0.875em;
      color: #dc3545;
    }

    .card-surface {
      background: rgba(255,255,255,0.98);
      border-radius: 14px;
      box-shadow: var(--card-shadow);
      padding: 22px;
      margin-bottom: 24px;
    }
    .btn-modern { border-radius: 12px; padding: 10px 16px; font-weight: 600; }
    .btn-add { background: linear-gradient(135deg,#5eead4,#60a5fa); border: none; color: #04243a; }
    .btn-danger { border-radius:12px; }
    .table-card { border-radius: 14px; overflow: hidden; box-shadow: var(--card-shadow); }
    .table thead th { background: linear-gradient(90deg,#b3c6ff,#81ecec); }
    .badge-status { font-weight:600; padding:6px 10px; border-radius:999px; font-size:12px; }
    .badge-success { background:#e6f8ef; color:#0f9d58; }
    .badge-warning { background:#fff8e8; color:#a16207; }
    .badge-danger { background:#fff0f1; color:#be123c; }
    .badge-secondary { background:#f0f4f8; color:#475569; }
    input, select { border-radius: 10px; border: 1px solid #e6eef9; padding: 10px; }

    .status-tab {
      display: inline-block;
      margin: 0 6px 8px 0;
      padding: 10px 22px;
      border-radius: 999px;
      font-weight: 600;
      background: #f3f6fa;
      color: #2563eb;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(59,130,246,0.06);
    }
    .status-tab.active {
      box-shadow: 0 6px 15px rgba(59,130,246,0.18);
      transform: translateY(-2px) scale(1.04);
    }
    .status-tab[data-status=""].active {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      border-color: #2563eb;
    }
    .status-tab[data-status="Expired"].active {
      background: #f0f4f8;
      color: #475569;
      border-color: #475569;
    }
    .status-tab[data-status="H (today)"].active {
      background: #fff0f1;
      color: #be123c;
      border-color: #be123c;
    }
    .status-tab[data-status="H-1"].active {
      background: #fff8e8;
      color: #a16207;
      border-color: #a16207;
    }
    .status-tab[data-status="H-3 or more"].active {
      background: #e6f8ef;
      color: #0f9d58;
      border-color: #0f9d58;
    }

    .vertical-tabs-container {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 1rem;
    }
    .vertical-tabs {
      display: flex;
      flex-direction: column;
      border-radius: 0.5rem 0 0 0.5rem;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      min-width: 140px;
      height: 100%;
      padding: 0.5rem 0;
    }
    .vertical-tabs .status-tab {
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      text-align: left;
      font-weight: 500;
      color: #495057;
      cursor: pointer;
      border-radius: 0;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      margin: 0;
    }
    .vertical-tabs .status-tab[data-status=""].active {
      background: linear-gradient(to right, #3b82f6 0%, #60a5fa 100%);
      color: white;
      border-left: 4px solid #2563eb;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="Expired"].active {
      background: #f0f4f8;
      color: #475569;
      border-left: 4px solid #475569;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H (today)"].active {
      background: #fff0f1;
      color: #be123c;
      border-left: 4px solid #be123c;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-1"].active {
      background: #fff8e8;
      color: #a16207;
      border-left: 4px solid #a16207;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-2"].active {
      background: #e0f2f7;
      color: #0288d1;
      border-left: 4px solid #0288d1;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-3 or more"].active {
      background: #e6f8ef;
      color: #0f9d58;
      border-left: 4px solid #0f9d58;
      font-weight: 600;
    }
    .reminder-table-wrapper {
      flex: 1;
      background: #fff;
      border-radius: 0 0.5rem 0.5rem 0;
      border: 1px solid #dee2e6;
      border-left: none;
      padding: 1rem 1rem 1rem 0.5rem;
      min-width: 0;
    }
    @media (max-width: 768px) {
      .vertical-tabs-container {
        flex-direction: column;
      }
      .vertical-tabs {
        flex-direction: row;
        border-radius: 0.5rem 0.5rem 0 0;
        min-width: 0;
        width: 100%;
        border-bottom: 1px solid #dee2e6;
        border-right: none;
      }
      .vertical-tabs .status-tab {
        border-left: none;
        border-bottom: 4px solid transparent;
        border-radius: 0;
        text-align: center;
        flex: 1;
      }
      /* Mobile color states */
      .vertical-tabs .status-tab[data-status=""].active {
        border-bottom: 4px solid #2563eb;
        border-left: none;
        background: linear-gradient(to bottom, #3b82f6 0%, #60a5fa 100%);
      }
      .vertical-tabs .status-tab[data-status="Expired"].active {
        border-bottom: 4px solid #475569;
        border-left: none;
      }
      .vertical-tabs .status-tab[data-status="H (today)"].active {
        border-bottom: 4px solid #be123c;
        border-left: none;
      }
    .vertical-tabs .status-tab[data-status="H-1"].active {
      background: #fff8e8;
      color: #a16207;
      border-left: 4px solid #a16207;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-2"].active {
      background: #e0f2f7;
      color: #0288d1;
      border-left: 4px solid #0288d1;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-3 or more"].active {
      background: #e6f8ef;
      color: #0f9d58;
      border-left: 4px solid #0f9d58;
      font-weight: 600;
    }
    .reminder-table-wrapper {
        border-radius: 0 0 0.5rem 0.5rem;
        border-top: none;
        border-left: 1px solid #dee2e6;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-title gradient-text text-center">📅 Sistem Pengingat Uji Kendaraan Dishub</div>

    <!-- Form input -->
    <div class="card-surface">
      <h5 class="mb-3"><i class="bi bi-plus-circle"></i> Tambah Reminder Baru</h5>
      <form id="reminderForm" novalidate>
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Pemilik <span class="text-muted" style="font-size:12px">(Sesuai STNK/KTP)</span></label>
            <input type="text" class="form-control" name="name" id="nameInput" required placeholder="Nama sesuai STNK/KTP">
            <div class="invalid-feedback">Nama pemilik harus diisi</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Nomor Kendaraan</label>
            <input type="text" class="form-control" name="vehicle_number" id="vehicleNumberInput" required placeholder="AB 1234 CD">
            <div class="invalid-feedback">Nomor kendaraan harus diisi</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">No Uji</label>
            <input type="text" class="form-control" name="no_uji" id="noUjiInput" required placeholder="SLO 6798/BDG/6543/DPR 5890/JKT 3417">
            <div class="invalid-feedback">Nomor uji harus diisi</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Jenis Kendaraan</label>
            <select class="form-control" name="jenis_kendaraan" id="jenisKendaraanInput" required>
              <option value="">Pilih Jenis Kendaraan</option>
              <option value="Truck">Truck</option>
              <option value="Pickup">Pickup</option>
              <option value="Mobil barang">Mobil barang</option>
              <option value="Tronton">Tronton</option>
            </select>
            <div class="invalid-feedback">Jenis kendaraan harus dipilih</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tanggal Uji</label>
            <input type="date" class="form-control" name="test_date" id="testDateInput" required>
            <div class="invalid-feedback">Tanggal uji harus diisi</div>
          </div>
          <div class="col-md-6">
            <label class="form-label">No. WhatsApp</label>
            <div class="input-group has-validation">
              <input type="text" class="form-control" id="phoneInput" name="phone" placeholder="812xxxxxx" pattern="^[0-9]{9,13}$">
              <button type="button" class="btn btn-outline-secondary" id="idFlagBtn">🇮🇩</button>
              <div class="invalid-feedback">Format nomor WhatsApp tidak valid (contoh: 81234567890)</div>
            </div>
            <small class="text-muted">Format: 812xxxxxxx (tanpa awalan 0)</small>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-add btn-modern" id="submitBtn">
            <span class="spinner-border spinner-border-sm me-2 d-none" id="submitSpinner" role="status" aria-hidden="true"></span>
            <span id="submitText">💾 Simpan Reminder</span>
          </button>
        </div>
      </form>
    </div>

    <!-- Tab status -->
    <div class="vertical-tabs-container">
      <div class="vertical-tabs" id="statusTabs">
        <!-- Tab status akan diisi via JS -->
      </div>
      <div class="reminder-table-wrapper">
        <!-- Tabel data -->
        <div class="table-card bg-white">
          <div class="p-3 border-bottom d-flex flex-wrap justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3 mb-2 mb-md-0">
              <button id="btnRefresh" class="btn btn-refresh btn-modern me-2"><i class="bi bi-arrow-clockwise me-2"></i>Refresh</button>
              <div>
                <h5 class="mb-0">Daftar Reminder</h5>
                <small class="text-muted">Data pengingat uji kendaraan</small>
              </div>
            </div>
          </div>
          <!-- Loading indicator for table -->
          <div id="tableLoading" class="text-center my-4 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2">Memuat data...</p>
          </div>
          
          <div class="p-3 table-responsive">
            <table class="table table-hover align-middle" id="reminderTable">
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>No. Kendaraan</th>
                  <th>No Uji</th>
                  <th>Jenis Kendaraan</th>
                  <th>Tanggal Uji</th>
                  <th>No. WA</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
            <div id="emptyTableMessage" class="text-center my-4 d-none">
              <p class="text-muted">Tidak ada data pengingat untuk ditampilkan.</p>
            </div>
          </div>
          <div class="p-3 d-flex gap-2 flex-wrap">
            <button class="btn btn-success btn-modern flex-fill" id="runNowBtn">▶️ Kirim Semua Hari Ini</button>
            <button class="btn btn-danger btn-modern flex-fill" id="clearBtn">🗑️ Hapus Semua</button>
            <button id="resetAuthBtn" class="btn btn-warning btn-modern flex-fill">🔄 Reset Login WA</button>
            <button id="btnLogout" class="btn btn-outline-secondary btn-modern">🚪 Keluar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper: mapping warna tab status
    const tabStatusColor = {
      "": {
        bg: "linear-gradient(135deg, #3b82f6, #2563eb)", color: "#fff", border: "#2563eb" },
      "Expired": {
        bg: "#f0f4f8", color: "#475569", border: "#475569" },
      "H (today)": {
        bg: "#fff0f1", color: "#be123c", border: "#be123c" },
      "H-1": {
        bg: "#fff8e8", color: "#a16207", border: "#a16207" },
      "H-2": {
        bg: "#e0f2f7", color: "#0288d1", border: "#0288d1" }, /* Added H-2 status color */
      "H-3 or more": {
        bg: "#e6f8ef", color: "#0f9d58", border: "#0f9d58" }
    };
    // Button Refresh
    document.addEventListener("DOMContentLoaded", () => {
      const btnRefresh = document.getElementById("btnRefresh");
      if (btnRefresh) {
        btnRefresh.addEventListener("click", () => {
          loadReminders();
          // Reset tab filter ke 'Semua'
          document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
          document.querySelector('.status-tab[data-status=""]').classList.add('active');
          lastTab = null;
          Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Data sudah di-refresh', showConfirmButton:false, timer:1600 });
        });
      }
    });
    const API_BASE = "http://localhost:5000";

    function normalizePhone(phone) {
      phone = phone.trim();
      if (phone.startsWith("0")) return "62" + phone.slice(1);
      else if (!phone.startsWith("62")) return "62" + phone;
      return phone;
    }


    document.addEventListener("DOMContentLoaded", () => {
      // ID Flag Button
      const idFlagBtn = document.getElementById("idFlagBtn");
      if (idFlagBtn) {
        idFlagBtn.addEventListener("click", () => {
          let input = document.getElementById("phoneInput");
          if (input) input.value = normalizePhone(input.value);
        });
      }

      // Logout / Keluar Button
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          Swal.fire({
            title: 'Keluar?',
            text: 'Anda akan keluar dari Dashboard',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Keluar',
            cancelButtonText: 'Batal'
          }).then(result => {
            if (result.isConfirmed) {
              Swal.fire({
                icon: 'success',
                title: 'Berhasil Keluar',
                showConfirmButton: false,
                timer: 1200
              });
              setTimeout(() => {
                window.location.href = "http://127.0.0.1:5000/";
              }, 1300);
            }
          });
        });
      }

      // Reset Auth Button
      const resetAuthBtn = document.getElementById("resetAuthBtn");
      if (resetAuthBtn) {
        resetAuthBtn.addEventListener("click", async function() {
          const confirm = await Swal.fire({
            title: "Reset Login WhatsApp?",
            text: "Aksi ini akan menghapus sesi login WhatsApp. Lanjutkan?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, reset",
            cancelButtonText: "Batal"
          });
          if (!confirm.isConfirmed) return;
          const btn = this;
          btn.disabled = true;
          btn.textContent = "⏳ Resetting...";
          try {
            const res = await fetch("http://localhost:3000/reset-auth", { method: "DELETE" });
            const data = await res.json();
            Swal.fire("🔄 Reset", data.message, "info").then(() => {
              window.location.href = "login.html";
            });
          } catch (err) {
            Swal.fire("⚠️ Error", "Gagal reset auth: " + err, "error");
          } finally {
            btn.disabled = false;
            btn.textContent = "🔄 Reset Login WA";
          }
        });
      }
    });

    async function loadReminders() {
      const tableLoading = document.getElementById('tableLoading');
      const tableBody = document.querySelector('#reminderTable tbody');
      
      try {
        // Show loading indicator
        if (tableLoading) tableLoading.classList.remove('d-none');
        if (tableBody) tableBody.classList.add('opacity-50');
        
        let res = await fetch(`${API_BASE}/list?format=json`);
        let data = await res.json();
        window.allReminders = data;
        renderReminderTable();
      } catch (e) {
        console.error("Error loading reminders:", e);
        Swal.fire("⚠️ Error", "Terjadi kesalahan saat memuat data: " + e.message, "error");
      } finally {
        // Hide loading indicator
        if (tableLoading) tableLoading.classList.add('d-none');
        if (tableBody) tableBody.classList.remove('opacity-50');
      }
    }

    function renderReminderTable(statusFilter = null) {
      let tbody = document.querySelector("#reminderTable tbody");
      tbody.innerHTML = "";
      let filtered = window.allReminders || [];
      if (statusFilter && statusFilter !== "") {
        filtered = filtered.filter(r => r.status === statusFilter);
      }

      if (filtered.length === 0) {
        document.getElementById('emptyTableMessage').classList.remove('d-none');
      } else {
        document.getElementById('emptyTableMessage').classList.add('d-none');
      }

      filtered.forEach(r => {
        let badgeClass = "badge-secondary";
        switch (r.status) {
          case "Expired": badgeClass = "badge-secondary"; break;
          case "H (today)": badgeClass = "badge-danger"; break;
          case "H-1": badgeClass = "badge-warning"; break;
          case "H-3 or more": badgeClass = "badge-success"; break;
          default: badgeClass = "badge-secondary";
        }
        let row = `
        <tr>
          <td>${r.name}</td>
          <td>${r.vehicle_number}</td>
          <td>${r.no_uji || '-'}</td>
          <td>${r.jenis_kendaraan || '-'}</td>
          <td>${r.test_date}</td>
          <td>${r.phone || '-'}</td>
          <td><span class="badge-status ${badgeClass}">${r.status || '-'}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="sendOne(${r.id})">📤 Kirim</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteOne(${r.id})">🗑️</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const reminderForm = document.getElementById("reminderForm");
      if (reminderForm) {
        // Validasi form saat input berubah
        const formInputs = reminderForm.querySelectorAll('input[required], select[required]');
        formInputs.forEach(input => {
          input.addEventListener('blur', function() {
            validateInput(this);
          });
          
          input.addEventListener('input', function() {
            if (this.classList.contains('is-invalid')) {
              validateInput(this);
            }
          });
        });
        
        // Fungsi validasi input
        function validateInput(input) {
          if (!input.value.trim()) {
            input.classList.add('is-invalid');
            input.classList.remove('is-valid');
            return false;
          } else {
            input.classList.remove('is-invalid');
            input.classList.add('is-valid');
            return true;
          }
        }
        
        // Validasi nomor telepon
        const phoneInput = document.getElementById('phoneInput');
        if (phoneInput) {
          phoneInput.addEventListener('blur', function() {
            if (this.value.trim() && !this.value.match(/^[0-9]{9,13}$/)) {
              this.classList.add('is-invalid');
              this.classList.remove('is-valid');
            } else if (this.value.trim()) {
              this.classList.remove('is-invalid');
              this.classList.add('is-valid');
            }
          });
        }
        
        // Fungsi validasi form lengkap
        function validateForm() {
          let isValid = true;
          formInputs.forEach(input => {
            if (!validateInput(input)) {
              isValid = false;
            }
          });
          return isValid;
        }
        
        reminderForm.addEventListener("submit", async e => {
          e.preventDefault();
          
          // Validasi form
          if (!validateForm()) {
            Swal.fire('Periksa form', 'Semua field wajib diisi dengan benar!', 'warning');
            return;
          }
          
          // Tampilkan loading state
          const submitBtn = document.getElementById('submitBtn');
          const submitSpinner = document.getElementById('submitSpinner');
          const submitText = document.getElementById('submitText');
          
          submitBtn.disabled = true;
          submitSpinner.classList.remove('d-none');
          submitText.textContent = 'Menyimpan...';
          
          let formData = new FormData(e.target);
          let jsonData = {};
          // Di JS, hapus pengiriman field nik
          formData.forEach((v, k) => {
            if (k !== "nik") jsonData[k] = k === "phone" ? normalizePhone(v) : v;
          });

          try {
            let res = await fetch(`${API_BASE}/add`, {
              method: "POST",
              headers: {"Content-Type": "application/json"},
              body: JSON.stringify(jsonData)
            });
            
            if (res.ok) {
              Swal.fire("✅ Sukses", "Reminder berhasil ditambahkan!", "success");
              e.target.reset();
              
              // Reset validasi visual
              formInputs.forEach(input => {
                input.classList.remove('is-valid');
                input.classList.remove('is-invalid');
              });
              
              loadReminders();
            } else {
              Swal.fire("⚠️ Gagal", "Tidak bisa menambahkan reminder.", "error");
            }
          } catch (error) {
            Swal.fire("⚠️ Error", "Terjadi kesalahan: " + error.message, "error");
          } finally {
            // Kembalikan tombol ke keadaan semula
            submitBtn.disabled = false;
            submitSpinner.classList.add('d-none');
            submitText.textContent = '💾 Simpan Reminder';
          }
        });
      }
    });

    async function sendOne(id) {
      let res = await fetch(`${API_BASE}/send_one/${id}`, { method: "POST" });
      let data = await res.json();
      if (res.ok) {
        Swal.fire("📤 Terkirim", `Reminder ke ${data.id}, status: ${data.status}`, "success");
        loadReminders();
      } else {
        Swal.fire("⚠️ Gagal", "Gagal mengirim reminder!", "error");
      }
    }

    async function deleteOne(id) {
      const confirm = await Swal.fire({
        title: "Hapus reminder?",
        text: "Data ini tidak bisa dikembalikan.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Ya, hapus!",
        cancelButtonText: "Batal"
      });
      if (!confirm.isConfirmed) return;

      let res = await fetch(`${API_BASE}/delete/${id}`, { method: "DELETE" });
      if (res.ok) {
        Swal.fire("🗑️ Terhapus", "Reminder berhasil dihapus!", "success");
        loadReminders();
      } else {
        Swal.fire("⚠️ Gagal", "Tidak bisa menghapus reminder.", "error");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const runNowBtn = document.getElementById("runNowBtn");
      if (runNowBtn) {
        runNowBtn.addEventListener("click", async () => {
          const confirm = await Swal.fire({
            title: "Kirim semua reminder hari ini?",
            text: "Aksi ini akan mengirim semua pengingat yang jatuh tempo hari ini.",
            icon: "question",
            showCancelButton: true,
            confirmButtonText: "Ya, kirim sekarang",
            cancelButtonText: "Batal"
          });
          if (!confirm.isConfirmed) return;

          await fetch(`${API_BASE}/run_now`, { method: "POST" });
          Swal.fire("▶️ Diproses", "Reminder hari ini sedang dikirim.", "info");
          loadReminders();
        });
      }

      const clearBtn = document.getElementById("clearBtn");
      if (clearBtn) {
        clearBtn.addEventListener("click", async () => {
          const confirm = await Swal.fire({
            title: "Hapus semua reminder?",
            text: "Semua data akan hilang permanen.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, hapus semua",
            cancelButtonText: "Batal"
          });
          if (!confirm.isConfirmed) return;
          await fetch(`${API_BASE}/clear`, { method: "DELETE" });
          Swal.fire("🗑️ Terhapus", "Semua reminder berhasil dihapus!", "success");
          loadReminders();
        });
      }
    });


    // === Logout / Keluar ===
    document.getElementById("btnLogout").addEventListener("click", () => {
      Swal.fire({
        title: 'Keluar?',
        text: 'Anda akan keluar dari Dashboard',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Keluar',
        cancelButtonText: 'Batal'
      }).then(result => {
        if (result.isConfirmed) {
          Swal.fire({
            icon: 'success',
            title: 'Berhasil Keluar',
            showConfirmButton: false,
            timer: 1200
          });
          setTimeout(() => {
            window.location.href = "http://127.0.0.1:5000/";
          }, 1300);
        }
      });
    });

    // pertama kali load
    loadReminders();

    // Tab status modern & filter persis seperti db.html
    const statusList = [
      { label: "Semua", value: "" },
      { label: "Expired", value: "Expired" },
      { label: "H (today)", value: "H (today)" },
      { label: "H-1", value: "H-1" },
      { label: "H-2", value: "H-2" }, /* Added H-2 status */
      { label: "H-3 or more", value: "H-3 or more" }
    ];
    function renderStatusTabs() {
      const container = document.getElementById("statusTabs");
      container.innerHTML = statusList.map(s =>
        `<button type="button" class="status-tab" data-status="${s.value}">${s.label}</button>`
      ).join("");
    }
    renderStatusTabs();
    let lastTab = null;
    document.getElementById("statusTabs").addEventListener("click", function(e) {
      if (e.target.classList.contains("status-tab")) {
        const status = e.target.getAttribute("data-status");
        // Reset semua tab dan warna
        document.querySelectorAll('.status-tab').forEach(t => {
          t.classList.remove('active');
        });
        // Aktifkan tab ini
        let tab = document.querySelector(`.status-tab[data-status="${status}"]`);
        if (lastTab === status || status === "") {
          lastTab = null;
          tab.classList.add('active');
          renderReminderTable();
        } else {
          lastTab = status;
          tab.classList.add('active');
          renderReminderTable(status);
        }
      }
    });
  </script>

  <script>
    async function checkWhatsAppConnection() {
      try {
        const res = await fetch("http://localhost:3000/qr");
        const data = await res.json();

        if (!data.success && (!data.connection || data.connection.connection !== "open")) {
          console.warn("Belum login WhatsApp, redirect ke halaman login...");
          window.location.href = "http://localhost:3000/login.html";
        } else {
          console.log("✅ WhatsApp sudah terkoneksi, lanjutkan akses sistem pengingat.");
        }
      } catch (err) {
        console.error("Gagal memeriksa koneksi WhatsApp:", err);
        // kalau gagal konek ke server, anggap belum login
        window.location.href = "http://localhost:3000/login.html";
      }
    }

    // Delay the check to avoid immediate redirect on page load
    setTimeout(() => {
      document.addEventListener("DOMContentLoaded", () => {
        // Skip check if just logged in
        if (sessionStorage.getItem('justLoggedIn') === 'true') {
          sessionStorage.removeItem('justLoggedIn');
          console.log("Just logged in, skipping connection check.");
          return;
        }
        checkWhatsAppConnection();
      });
    }, 1000);
  </script>
</body>
</html>
