<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>WhatsApp Reminder - Dishub</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    .btn-refresh {
      background: linear-gradient(135deg,#5eead4,#60a5fa);
      border: none;
      color: #04243a;
      font-weight: 600;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(59,130,246,0.10);
      padding: 10px 16px;
      transition: box-shadow 0.18s, background 0.18s, color 0.18s;
    }
    .btn-refresh:hover, .btn-refresh:focus {
      background: linear-gradient(135deg,#60a5fa,#5eead4);
      color: #02111b;
      box-shadow: 0 6px 18px rgba(59,130,246,0.18);
    }
    :root{
      --bg1: #f6fbff;
      --accent1: #81d4fa;
      --accent2: #7ef6d7;
      --muted: #6b7280;
      --card-shadow: 0 10px 30px rgba(38,50,56,0.06);
    }
    body {
      font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background: linear-gradient(120deg, #f8fafc 0%, #e9f4ff 60%, #f1f6f9 100%);
      color: #1f2937;
      padding: 30px 18px;
    }
    .header-title {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 20px;

      /* Gradient text */
      background: linear-gradient(90deg, #00e676, #00bcd4, #448aff);
      background-clip: text;
      -webkit-background-clip: text; /* Safari/Chrome */
      color: transparent;
      -webkit-text-fill-color: transparent; /* Safari/Chrome */
    }

    .card-surface {
      background: rgba(255,255,255,0.98);
      border-radius: 14px;
      box-shadow: var(--card-shadow);
      padding: 22px;
      margin-bottom: 24px;
    }
    .btn-modern { border-radius: 12px; padding: 10px 16px; font-weight: 600; }
    .btn-add { background: linear-gradient(135deg,#5eead4,#60a5fa); border: none; color: #04243a; }
    .btn-danger { border-radius:12px; }
    .table-card { border-radius: 14px; overflow: hidden; box-shadow: var(--card-shadow); }
    .table thead th { background: linear-gradient(90deg,#b3c6ff,#81ecec); }
    .badge-status { font-weight:600; padding:6px 10px; border-radius:999px; font-size:12px; }
    .badge-success { background:#e6f8ef; color:#0f9d58; }
    .badge-warning { background:#fff8e8; color:#a16207; }
    .badge-danger { background:#fff0f1; color:#be123c; }
    .badge-secondary { background:#f0f4f8; color:#475569; }
    input, select { border-radius: 10px; border: 1px solid #e6eef9; padding: 10px; }

    .status-tab {
      display: inline-block;
      margin: 0 6px 8px 0;
      padding: 10px 22px;
      border-radius: 999px;
      font-weight: 600;
      background: #f3f6fa;
      color: #2563eb;
      cursor: pointer;
      transition: all 0.2s;
      border: 2px solid transparent;
      box-shadow: 0 2px 8px rgba(59,130,246,0.06);
    }
    .status-tab.active {
      box-shadow: 0 6px 15px rgba(59,130,246,0.18);
      transform: translateY(-2px) scale(1.04);
    }
    .status-tab[data-status=""].active {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #fff;
      border-color: #2563eb;
    }
    .status-tab[data-status="Expired"].active {
      background: #f0f4f8;
      color: #475569;
      border-color: #475569;
    }
    .status-tab[data-status="H (today)"].active {
      background: #fff0f1;
      color: #be123c;
      border-color: #be123c;
    }
    .status-tab[data-status="H-1"].active {
      background: #fff8e8;
      color: #a16207;
      border-color: #a16207;
    }
    .status-tab[data-status="H-3 or more"].active {
      background: #e6f8ef;
      color: #0f9d58;
      border-color: #0f9d58;
    }

    .vertical-tabs-container {
      display: flex;
      align-items: flex-start;
      gap: 0;
      margin-bottom: 1rem;
    }
    .vertical-tabs {
      display: flex;
      flex-direction: column;
      border-radius: 0.5rem 0 0 0.5rem;
      background: #f8f9fa;
      border: 1px solid #dee2e6;
      min-width: 140px;
      height: 100%;
      padding: 0.5rem 0;
    }
    .vertical-tabs .status-tab {
      padding: 0.75rem 1rem;
      border: none;
      background: none;
      text-align: left;
      font-weight: 500;
      color: #495057;
      cursor: pointer;
      border-radius: 0;
      border-left: 4px solid transparent;
      transition: all 0.2s ease;
      margin: 0;
    }
    .vertical-tabs .status-tab[data-status=""].active {
      background: linear-gradient(to right, #3b82f6 0%, #60a5fa 100%);
      color: white;
      border-left: 4px solid #2563eb;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="Expired"].active {
      background: #f0f4f8;
      color: #475569;
      border-left: 4px solid #475569;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H (today)"].active {
      background: #fff0f1;
      color: #be123c;
      border-left: 4px solid #be123c;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-1"].active {
      background: #fff8e8;
      color: #a16207;
      border-left: 4px solid #a16207;
      font-weight: 600;
    }
    .vertical-tabs .status-tab[data-status="H-3 or more"].active {
      background: #e6f8ef;
      color: #0f9d58;
      border-left: 4px solid #0f9d58;
      font-weight: 600;
    }
    .reminder-table-wrapper {
      flex: 1;
      background: #fff;
      border-radius: 0 0.5rem 0.5rem 0;
      border: 1px solid #dee2e6;
      border-left: none;
      padding: 1rem 1rem 1rem 0.5rem;
      min-width: 0;
    }
    @media (max-width: 768px) {
      .vertical-tabs-container {
        flex-direction: column;
      }
      .vertical-tabs {
        flex-direction: row;
        border-radius: 0.5rem 0.5rem 0 0;
        min-width: 0;
        width: 100%;
        border-bottom: 1px solid #dee2e6;
        border-right: none;
      }
      .vertical-tabs .status-tab {
        border-left: none;
        border-bottom: 4px solid transparent;
        border-radius: 0;
        text-align: center;
        flex: 1;
      }
      /* Mobile color states */
      .vertical-tabs .status-tab[data-status=""].active {
        border-bottom: 4px solid #2563eb;
        border-left: none;
        background: linear-gradient(to bottom, #3b82f6 0%, #60a5fa 100%);
      }
      .vertical-tabs .status-tab[data-status="Expired"].active {
        border-bottom: 4px solid #475569;
        border-left: none;
      }
      .vertical-tabs .status-tab[data-status="H (today)"].active {
        border-bottom: 4px solid #be123c;
        border-left: none;
      }
      .vertical-tabs .status-tab[data-status="H-1"].active {
        border-bottom: 4px solid #a16207;
        border-left: none;
      }
      .vertical-tabs .status-tab[data-status="H-3 or more"].active {
        border-bottom: 4px solid #0f9d58;
        border-left: none;
      }
      .reminder-table-wrapper {
        border-radius: 0 0 0.5rem 0.5rem;
        border-top: none;
        border-left: 1px solid #dee2e6;
        padding: 1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header-title text-center">üìÖ Sistem Pengingat Uji Kendaraan Dishub</div>

    <!-- Form input -->
    <div class="card-surface">
      <h5 class="mb-3"><i class="bi bi-plus-circle"></i> Tambah Reminder Baru</h5>
      <form id="reminderForm">
        <div class="row g-3">
          <div class="col-md-6">
            <label class="form-label">Nama Pemilik <span class="text-muted" style="font-size:12px">(Sesuai STNK/KTP)</span></label>
            <input type="text" class="form-control" name="name" required placeholder="Nama sesuai STNK/KTP">
          </div>
          <div class="col-md-6">
            <label class="form-label">Nomor Kendaraan</label>
            <input type="text" class="form-control" name="vehicle_number" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">No Uji</label>
            <input type="text" class="form-control" name="no_uji" required placeholder="SLO 6798/BDG/6543/DPR 5890/JKT 3417">
          </div>
          <div class="col-md-6">
            <label class="form-label">Jenis Kendaraan</label>
            <select class="form-control" name="jenis_kendaraan" required>
              <option value="">Pilih Jenis Kendaraan</option>
              <option value="Truck">Truck</option>
              <option value="Pickup">Pickup</option>
              <option value="Mobil barang">Mobil barang</option>
              <option value="Tronton">Tronton</option>
            </select>
          </div>
          <div class="col-md-6">
            <label class="form-label">Tanggal Uji</label>
            <input type="date" class="form-control" name="test_date" required>
          </div>
          <div class="col-md-6">
            <label class="form-label">No. WhatsApp</label>
            <div class="input-group">
              <input type="text" class="form-control" id="phoneInput" name="phone" placeholder="812xxxxxx">
              <button type="button" class="btn btn-outline-secondary" id="idFlagBtn">üáÆüá©</button>
            </div>
          </div>
        </div>
        <div class="mt-4">
          <button type="submit" class="btn btn-add btn-modern">üíæ Simpan Reminder</button>
        </div>
      </form>
    </div>

    <!-- Tab status -->
    <div class="vertical-tabs-container">
      <div class="vertical-tabs" id="statusTabs">
        <!-- Tab status akan diisi via JS -->
      </div>
      <div class="reminder-table-wrapper">
        <!-- Tabel data -->
        <div class="table-card bg-white">
          <div class="p-3 border-bottom d-flex justify-content-between align-items-center">
            <div class="d-flex align-items-center gap-3">
              <button id="btnRefresh" class="btn btn-refresh btn-modern me-2"><i class="bi bi-arrow-clockwise me-2"></i>Refresh</button>
              <div>
                <h5 class="mb-0">Daftar Reminder</h5>
                <small class="text-muted">Data pengingat uji kendaraan</small>
              </div>
            </div>
    
          </div>
          <div class="p-3 table-responsive">
            <table class="table table-hover align-middle" id="reminderTable">
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>No. Kendaraan</th>
                  <th>No Uji</th>
                  <th>Jenis Kendaraan</th>
                  <th>Tanggal Uji</th>
                  <th>No. WA</th>
                  <th>Status</th>
                  <th>Aksi</th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
          <div class="p-3 d-flex gap-2 flex-wrap">
            <button class="btn btn-success btn-modern flex-fill" id="runNowBtn">‚ñ∂Ô∏è Kirim Semua Hari Ini</button>
            <button class="btn btn-danger btn-modern flex-fill" id="clearBtn">üóëÔ∏è Hapus Semua</button>
            <button id="resetAuthBtn" class="btn btn-warning btn-modern flex-fill">üîÑ Reset Login WA</button>
            <button id="btnLogout" class="btn btn-outline-secondary btn-modern">üö™ Keluar</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper: mapping warna tab status
    const tabStatusColor = {
      "": {
        bg: "linear-gradient(135deg, #3b82f6, #2563eb)", color: "#fff", border: "#2563eb" },
      "Expired": {
        bg: "#f0f4f8", color: "#475569", border: "#475569" },
      "H (today)": {
        bg: "#fff0f1", color: "#be123c", border: "#be123c" },
      "H-1": {
        bg: "#fff8e8", color: "#a16207", border: "#a16207" },
      "H-3 or more": {
        bg: "#e6f8ef", color: "#0f9d58", border: "#0f9d58" }
    };
    // Button Refresh
    document.addEventListener("DOMContentLoaded", () => {
      const btnRefresh = document.getElementById("btnRefresh");
      if (btnRefresh) {
        btnRefresh.addEventListener("click", () => {
          loadReminders();
          // Reset tab filter ke 'Semua'
          document.querySelectorAll('.status-tab').forEach(t => t.classList.remove('active'));
          document.querySelector('.status-tab[data-status=""]').classList.add('active');
          lastTab = null;
          Swal.fire({ toast:true, position:'top-end', icon:'success', title:'Data sudah di-refresh', showConfirmButton:false, timer:1600 });
        });
      }
    });
    const API_BASE = "http://localhost:5000";

    function normalizePhone(phone) {
      phone = phone.trim();
      if (phone.startsWith("0")) return "62" + phone.slice(1);
      else if (!phone.startsWith("62")) return "62" + phone;
      return phone;
    }


    document.addEventListener("DOMContentLoaded", () => {
      // ID Flag Button
      const idFlagBtn = document.getElementById("idFlagBtn");
      if (idFlagBtn) {
        idFlagBtn.addEventListener("click", () => {
          let input = document.getElementById("phoneInput");
          if (input) input.value = normalizePhone(input.value);
        });
      }

      // Logout / Keluar Button
      const btnLogout = document.getElementById("btnLogout");
      if (btnLogout) {
        btnLogout.addEventListener("click", () => {
          Swal.fire({
            title: 'Keluar?',
            text: 'Anda akan keluar dari Dashboard',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ya, Keluar',
            cancelButtonText: 'Batal'
          }).then(result => {
            if (result.isConfirmed) {
              Swal.fire({
                icon: 'success',
                title: 'Berhasil Keluar',
                showConfirmButton: false,
                timer: 1200
              });
              setTimeout(() => {
                window.location.href = "http://127.0.0.1:5000/";
              }, 1300);
            }
          });
        });
      }

      // Reset Auth Button
      const resetAuthBtn = document.getElementById("resetAuthBtn");
      if (resetAuthBtn) {
        resetAuthBtn.addEventListener("click", async function() {
          const confirm = await Swal.fire({
            title: "Reset Login WhatsApp?",
            text: "Aksi ini akan menghapus sesi login WhatsApp. Lanjutkan?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, reset",
            cancelButtonText: "Batal"
          });
          if (!confirm.isConfirmed) return;
          const btn = this;
          btn.disabled = true;
          btn.textContent = "‚è≥ Resetting...";
          try {
            const res = await fetch("http://localhost:3000/reset-auth", { method: "DELETE" });
            const data = await res.json();
            Swal.fire("üîÑ Reset", data.message, "info").then(() => {
              window.location.href = "login.html";
            });
          } catch (err) {
            Swal.fire("‚ö†Ô∏è Error", "Gagal reset auth: " + err, "error");
          } finally {
            btn.disabled = false;
            btn.textContent = "üîÑ Reset Login WA";
          }
        });
      }
    });

    async function loadReminders() {
      let res = await fetch(`${API_BASE}/list?format=json`);
      let data = await res.json();
      window.allReminders = data;
      renderReminderTable();
    }

    function renderReminderTable(statusFilter = null) {
      let tbody = document.querySelector("#reminderTable tbody");
      tbody.innerHTML = "";
      let filtered = window.allReminders || [];
      if (statusFilter && statusFilter !== "") {
        filtered = filtered.filter(r => r.status === statusFilter);
      }
      filtered.forEach(r => {
        let badgeClass = "badge-secondary";
        switch (r.status) {
          case "Expired": badgeClass = "badge-secondary"; break;
          case "H (today)": badgeClass = "badge-danger"; break;
          case "H-1": badgeClass = "badge-warning"; break;
          case "H-3 or more": badgeClass = "badge-success"; break;
          default: badgeClass = "badge-secondary";
        }
        let row = `
        <tr>
          <td>${r.name}</td>
          <td>${r.vehicle_number}</td>
          <td>${r.no_uji || '-'}</td>
          <td>${r.jenis_kendaraan || '-'}</td>
          <td>${r.test_date}</td>
          <td>${r.phone || '-'}</td>
          <td><span class="badge-status ${badgeClass}">${r.status || '-'}</span></td>
          <td>
            <button class="btn btn-sm btn-primary" onclick="sendOne(${r.id})">üì§ Kirim</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteOne(${r.id})">üóëÔ∏è</button>
          </td>
        </tr>`;
        tbody.innerHTML += row;
      });
    }

    document.addEventListener("DOMContentLoaded", () => {
      const reminderForm = document.getElementById("reminderForm");
      if (reminderForm) {
        reminderForm.addEventListener("submit", async e => {
          e.preventDefault();
          let formData = new FormData(e.target);
          let jsonData = {};
          // Di JS, hapus pengiriman field nik
          formData.forEach((v, k) => {
            if (k !== "nik") jsonData[k] = k === "phone" ? normalizePhone(v) : v;
          });
          // Ensure required fields
          if (!jsonData.name || !jsonData.vehicle_number || !jsonData.test_date || !jsonData.no_uji || !jsonData.jenis_kendaraan) {
            Swal.fire('Periksa form', 'Semua field wajib diisi!', 'warning');
            return;
          }

          let res = await fetch(`${API_BASE}/add`, {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify(jsonData)
          });
          if (res.ok) {
            Swal.fire("‚úÖ Sukses", "Reminder berhasil ditambahkan!", "success");
            e.target.reset();
            loadReminders();
          } else {
            Swal.fire("‚ö†Ô∏è Gagal", "Tidak bisa menambahkan reminder.", "error");
          }
        });
      }
    });

    async function sendOne(id) {
      let res = await fetch(`${API_BASE}/send_one/${id}`, { method: "POST" });
      let data = await res.json();
      if (res.ok) {
        Swal.fire("üì§ Terkirim", `Reminder ke ${data.id}, status: ${data.status}`, "success");
        loadReminders();
      } else {
        Swal.fire("‚ö†Ô∏è Gagal", "Gagal mengirim reminder!", "error");
      }
    }

    async function deleteOne(id) {
      const confirm = await Swal.fire({
        title: "Hapus reminder?",
        text: "Data ini tidak bisa dikembalikan.",
        icon: "warning",
        showCancelButton: true,
        confirmButtonText: "Ya, hapus!",
        cancelButtonText: "Batal"
      });
      if (!confirm.isConfirmed) return;

      let res = await fetch(`${API_BASE}/delete/${id}`, { method: "DELETE" });
      if (res.ok) {
        Swal.fire("üóëÔ∏è Terhapus", "Reminder berhasil dihapus!", "success");
        loadReminders();
      } else {
        Swal.fire("‚ö†Ô∏è Gagal", "Tidak bisa menghapus reminder.", "error");
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      const runNowBtn = document.getElementById("runNowBtn");
      if (runNowBtn) {
        runNowBtn.addEventListener("click", async () => {
          await fetch(`${API_BASE}/run_now`, { method: "POST" });
          Swal.fire("‚ñ∂Ô∏è Diproses", "Reminder hari ini sedang dikirim.", "info");
          loadReminders();
        });
      }

      const clearBtn = document.getElementById("clearBtn");
      if (clearBtn) {
        clearBtn.addEventListener("click", async () => {
          const confirm = await Swal.fire({
            title: "Hapus semua reminder?",
            text: "Semua data akan hilang permanen.",
            icon: "warning",
            showCancelButton: true,
            confirmButtonText: "Ya, hapus semua",
            cancelButtonText: "Batal"
          });
          if (!confirm.isConfirmed) return;
          await fetch(`${API_BASE}/clear`, { method: "DELETE" });
          Swal.fire("üóëÔ∏è Terhapus", "Semua reminder berhasil dihapus!", "success");
          loadReminders();
        });
      }
    });


    // === Logout / Keluar ===
    document.getElementById("btnLogout").addEventListener("click", () => {
      Swal.fire({
        title: 'Keluar?',
        text: 'Anda akan keluar dari Dashboard',
        icon: 'warning',
        showCancelButton: true,
        confirmButtonText: 'Ya, Keluar',
        cancelButtonText: 'Batal'
      }).then(result => {
        if (result.isConfirmed) {
          Swal.fire({
            icon: 'success',
            title: 'Berhasil Keluar',
            showConfirmButton: false,
            timer: 1200
          });
          setTimeout(() => {
            window.location.href = "http://127.0.0.1:5000/";
          }, 1300);
        }
      });
    });

    // pertama kali load
    loadReminders();

    // Tab status modern & filter persis seperti db.html
    const statusList = [
      { label: "Semua", value: "" },
      { label: "Expired", value: "Expired" },
      { label: "H (today)", value: "H (today)" },
      { label: "H-1", value: "H-1" },
      { label: "H-3 or more", value: "H-3 or more" }
    ];
    function renderStatusTabs() {
      const container = document.getElementById("statusTabs");
      container.innerHTML = statusList.map(s =>
        `<button type="button" class="status-tab" data-status="${s.value}">${s.label}</button>`
      ).join("");
    }
    renderStatusTabs();
    let lastTab = null;
    document.getElementById("statusTabs").addEventListener("click", function(e) {
      if (e.target.classList.contains("status-tab")) {
        const status = e.target.getAttribute("data-status");
        // Reset semua tab dan warna
        document.querySelectorAll('.status-tab').forEach(t => {
          t.classList.remove('active');
        });
        // Aktifkan tab ini
        let tab = document.querySelector(`.status-tab[data-status="${status}"]`);
        if (lastTab === status || status === "") {
          lastTab = null;
          tab.classList.add('active');
          renderReminderTable();
        } else {
          lastTab = status;
          tab.classList.add('active');
          renderReminderTable(status);
        }
      }
    });
  </script>
</body>
</html>
